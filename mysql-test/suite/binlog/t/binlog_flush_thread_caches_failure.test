--source include/have_log_bin.inc
--source include/have_binlog_format_row.inc
--source include/have_debug_sync.inc

RESET MASTER;

SET GLOBAL binlog_error_action = ABORT_SERVER;
SET GLOBAL sync_binlog = 1;
CREATE TABLE t1(i INT, c varchar(1024));
CREATE TABLE t2(i INT);
connect(con1,localhost,root,,);
connect(con2,localhost,root,,);

--connection con1
SET DEBUG_SYNC = "bgc_after_enrolling_for_flush_stage SIGNAL leader_enter_flush_stage WAIT_FOR follower_enter_flush_stage";
SET SESSION debug = "+d,simulate_do_write_cache_failure";
--send INSERT INTO t1 values (1, repeat('a', 1024));

--connection con2
SET DEBUG_SYNC = "now WAIT_FOR leader_enter_flush_stage";
SET DEBUG_SYNC = "bgc_after_enrolling_for_flush_stage SIGNAL follower_enter_flush_stage";
--send INSERT INTO t2 values (2);

--connection con1
--reap
--connection con2
--reap

--connection default
select i from t1;
select i from t2;
DROP table t1, t2;
--echo #check binlog file
let $datadir = `SELECT @@DATADIR`;
--exec $MYSQL_BINLOG --force-if-open --verbose $datadir/binlog.000001 | egrep '^CREATE|^DROP|^INSERT|^###'

# Cleanup
--disconnect con1
--disconnect con2
